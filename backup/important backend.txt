from flask import Flask, render_template, request, redirect, jsonify, session
import gspread
import os
from google.oauth2.service_account import Credentials
from datetime import datetime
import numpy as np
from tensorflow.keras.preprocessing import image
from tensorflow.keras.applications.resnet50 import ResNet50, preprocess_input, decode_predictions

app = Flask(__name__)

# REQUIRED for session login tracking
app.secret_key = "your_secret_key_here"

# Load Keras pretrained ResNet50 (ImageNet weights)
model = ResNet50(weights="imagenet")
print("✅ ResNet50 model loaded successfully!")


def get_sheet():
    creds = Credentials.from_service_account_file(
        "Database.json",
        scopes=["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    )
    client = gspread.authorize(creds)
    sheet = client.open("Database").sheet1
    return sheet


def predict_image(img_path):
    img = image.load_img(img_path, target_size=(224, 224))
    img_array = image.img_to_array(img)
    img_array = np.expand_dims(img_array, axis=0)
    img_array = preprocess_input(img_array)

    preds = model.predict(img_array)
    decoded = decode_predictions(preds, top=1)[0][0]
    class_name = decoded[1]
    confidence = decoded[2]

    return f"File: {os.path.basename(img_path)} → Prediction: {class_name} ({confidence * 100:.2f}%)"


@app.route('/')
def home():
    return render_template('homepage.html')


@app.route('/extension')
def extension():
    return render_template('index.html')


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        data = request.get_json()
        email = data["email"]
        password = data["password"]

        sheet = get_sheet()
        users = sheet.get_all_records()

        for user in users:
            if user["email"] == email and user["password"] == password:
                # ✅ set login session
                session["logged_in"] = True
                session["user_email"] = email
                return jsonify({"message": "Login successful"}), 200

        return jsonify({"error": "Invalid email or password"}), 400

    return render_template('login.html')


@app.route('/signup', methods=['GET', 'POST'])
def signup():
    if request.method == 'POST':
        data = request.get_json()
        fullname = data["fullname"]
        email = data["email"]
        password = data["password"]

        sheet = get_sheet()
        sheet.append_row([fullname, email, password, str(datetime.now())])

        return jsonify({"message": "Signup successful"}), 200

    return render_template('signup.html')


@app.route('/predict', methods=['POST'])
def predict():
    if 'file' not in request.files:
        return "No file uploaded"

    file = request.files['file']
    if file.filename == '':
        return "No selected file"

    os.makedirs('uploads', exist_ok=True)
    filepath = os.path.join('uploads', file.filename)
    file.save(filepath)

    result = predict_image(filepath)
    return render_template('result.html', result=result, img_path=filepath)


if __name__ == "__main__":
    app.run(debug=True)
